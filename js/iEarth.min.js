!function(a){var b=function(){var b=a.localStorage;return{getItem:function(a){return b.getItem(a)},setItem:function(a,c){b.removeItem(a),b.setItem(a,c)},removeItem:function(a){b.removeItem(a)}}}(),c=function(){function a(a,b){for(var c in b)a[c]=b[c]}function b(a){return a+"_"+Date.now()+"_"+Math.random()}function c(a){var b,c,d,e,f,g=new Date(1e3*a),h=new Date,i=h-g;return 36e5>i?f=0==Math.ceil(i/216e3)?"刚刚":Math.ceil(i/216e3).toString()+"分钟前":(b=g.getHours(),c=g.getMinutes(),d=10>b?"0"+b.toString():b.toString(),e=10>c?"0"+c.toString():c.toString(),f=h.getFullYear()===g.getFullYear()?h.getDate()===g.getDate()?"今天"+d+":"+e:(g.getMonth()+1).toString()+"月"+g.getDate().toString()+"日 "+d+":"+e:g.getFullYear().toString()+"年 "+(g.getMonth()+1).toString()+"月"+g.getDate().toString()+"日 "+d+":"+e),f}return{extend:a,uuid:b,readableDate:c}}(),d=(function(){var a=function(){this.listener={}};return a.prototype.addListener=function(a,b){this.listener[a]||(this.listener[a]=[]),this.listener[a].push(b)},a.prototype.fire=function(a){var b=this.listener[a];if(b&&b.length)for(var c=0;c<b.length;c++)b[c]()},a}(),function(){var d="USER_LIST",e="CURRENT_USER",f=function(){this.dom=$("#userLoginRegister"),this.currentUser=null,this.userLoginRegisterError=$("#userLoginRegisterError"),this.userLoginRegisterUsername=$("#userLoginRegisterUsername"),this.userLoginRegisterPassword=$("#userLoginRegisterPassword"),this._bindEvent()};return c.extend(f.prototype,{_bindEvent:function(){var a=this;a.dom.on("click",".layer-manager-close",function(){a._hide()}).on("click",".submit",function(){a._doLogin()}).on("click",".register",function(){a._doRegister()}),a.userLoginRegisterUsername.on("focus",function(){a.userLoginRegisterError.hide()}),a.userLoginRegisterPassword.on("focus",function(){a.userLoginRegisterError.hide()})},_reset:function(){this.userLoginRegisterUsername.val(""),this.userLoginRegisterPassword.val("")},_show:function(){var b=a.innerHeight;this.dom.css("top",(b-350)/2),this.dom.fadeIn(100)},_doLogin:function(){if(this._validate()){var a=this.userLoginRegisterUsername.val().trim(""),b=this.userLoginRegisterPassword.val().trim("");this._isValid(a,b)?this.callback&&(this.callback(this.currentUser),this._hide()):this.userLoginRegisterError.html("用户名或密码错误").show()}else this.userLoginRegisterError.html("用户名、密码不能为空").show()},_doRegister:function(){if(this._validate()){var a=this.userLoginRegisterUsername.val().trim(""),c=this.userLoginRegisterPassword.val().trim("");if(this._isExists(a))this.userLoginRegisterError.html("用户名已存在").show();else{var d=this._saveUser(a,c);b.setItem(e,d),this.callback&&(this.callback({userid:d,username:a,password:c}),this._hide())}}else this.userLoginRegisterError.html("用户名、密码不能为空").show()},_isValid:function(a,c){var f=b.getItem(d);if(f){f=JSON.parse(f);for(var g=0;g<f.length;g++)if(f[g].username===a&&f[g].password===c)return this.currentUser=f[g],b.setItem(e,f[g].userid),!0;return!1}return!1},_isExists:function(a){var c=b.getItem(d);if(c){c=JSON.parse(c);for(var e=0;e<c.length;e++)if(c[e].username===a)return!0;return!1}return!1},_saveUser:function(a,e){var f=b.getItem(d);f=f?JSON.parse(f):[];var g=c.uuid("USER_");return f.push({userid:g,username:a,password:e}),b.setItem(d,JSON.stringify(f)),g},_validate:function(){var a=this.userLoginRegisterUsername.val().trim(""),b=this.userLoginRegisterPassword.val().trim("");return a&&b?!0:!1},_hide:function(){this.dom.fadeOut(100)},autoLogin:function(){var a=b.getItem(e),c=b.getItem(d);if(c&&a){c=JSON.parse(c);for(var f=0;f<c.length;f++)if(c[f].userid===a)return c[f];return null}return null},login:function(a){this.callback=a,this._reset(),this._show()},logout:function(){b.removeItem(e)}}),f}()),e=function(){this.dom=$("#mapEditor"),this.mapEditorTitle=$("#mapEditorTitle"),this.mapEditorInput=$("#mapEditorInput"),this._bindEvent()};c.extend(e.prototype,{_bindEvent:function(){var a=this;a.dom.on("click",".layer-manager-close",function(){a._hide()}).on("click",".layer-manager-btn.cancel",function(){a._hide()}).on("click",".layer-manager-btn.ok",function(){if(a.callback){var b=a.mapEditorInput.val().trim()||"未命名的地图";a.callback(b)}a._hide()})},_reset:function(a){this.mapEditorInput.val(a)},_show:function(){var b=a.innerWidth,c=a.innerHeight;this.dom.css("left",(b-402)/2).css("top",(c-172)/2),this.dom.fadeIn(100)},_hide:function(){this.dom.fadeOut(100)},createMap:function(a){this._reset(""),this.mapEditorTitle.html("创建地图"),this.callback=a,this._show()},editMap:function(a,b){this._reset(a),this.mapEditorTitle.html("修改地图标题"),this.callback=b,this._show()}});var f=function(){this.dom=$("#layerEditor"),this.layerEditorInput=$("#layerEditorInput"),this._bindEvent()};c.extend(f.prototype,{_bindEvent:function(){var a=this;a.dom.on("click",".layer-manager-close",function(){a._hide()}).on("click",".layer-manager-btn.cancel",function(){a._hide()}).on("click",".layer-manager-btn.ok",function(){if(a.callback){var b=a.layerEditorInput.val().trim()||"未命名的地图";a.callback(b)}a._hide()})},_reset:function(a){this.layerEditorInput.val(a)},_show:function(){var b=a.innerWidth,c=a.innerHeight;this.dom.css("left",(b-402)/2).css("top",(c-172)/2),this.dom.fadeIn(100)},_hide:function(){this.dom.fadeOut(100)},editLayer:function(a,b){this._reset(a),this.callback=b,this._show()}});var g=function(){var a="ALL_MAP_",d="MAP_",e="LAST_MAP_",f="MAP_ID",g=function(){this.userid=null,this.allMaps=[]};return c.extend(g.prototype,{setUserid:function(c){this.userid=c;var d=b.getItem(a+c);d&&(this.allMaps=JSON.parse(d))},getLastEditMap:function(){var a=b.getItem(e+this.userid);return this.currentEditMap=a?this.getMap(a):this.createDefaultMap(),this.currentEditMap},setDefaultMap:function(a){b.setItem(e+this.userid,a)},createDefaultMap:function(){var a=this.addMap("未命名的地图");return this.setDefaultMap(a.id),a},getMap:function(a){return JSON.parse(b.getItem(d+a))},addMap:function(e){var g={id:c.uuid(f),name:e,ctime:Date.now(),layerList:[{name:"未命名的图层",objectList:[]}]};return this.allMaps.splice(0,0,g.id),b.setItem(a+this.userid,JSON.stringify(this.allMaps)),b.setItem(d+g.id,JSON.stringify(g)),g},updateMap:function(a){b.setItem(d+a.id,JSON.stringify(a))},addLayerToMap:function(){},addObjectToLayer:function(){},removeMap:function(){},removeLayer:function(){},removeObject:function(){},getAllMaps:function(){for(var a=[],b=0;b<this.allMaps.length;b++)a.push(this.getMap(this.allMaps[b]));return a}}),g}(),h=function(){var b=function(a){this.dataController=a,this.htmlGenerator=_.template($("#mapListTemplate").html()),this.dom=$("#layerManager"),this.mapListC=$("#mapListC"),this.dom.find(".layer-manager-btn.ok").addClass("disable"),this._bindEvent()};return c.extend(b.prototype,{_bindEvent:function(){var a=this;a.dom.on("click",".layer-manager-close",function(){a._hide()}).on("click",".layer-manager-btn.cancel",function(){a._hide()}).on("click",".layer-manager-row",function(){a.mapListC.find(".layer-manager-row").removeClass("selected"),$(this).addClass("selected"),a.selectedIndex=$(this).index(),a.dom.find(".layer-manager-btn.ok").removeClass("disable")}).on("click",".layer-manager-btn.ok",function(){$(this).hasClass("disable")||(a.callback(a.maps[a.selectedIndex]),a._hide())})},_show:function(){var b=a.innerWidth,c=a.innerHeight;this.dom.css("left",(b-702)/2).css("top",(c-502)/2),this.dom.fadeIn(100)},_hide:function(){this.dom.fadeOut(100)},_fillHTML:function(){for(var a=0;a<this.maps.length;a++)this.maps[a].timeStr=c.readableDate(this.maps[a].ctime/1e3);this.mapListC.html(this.htmlGenerator({maps:this.maps}))},openMap:function(a){this.callback=a,this.maps=this.dataController.getAllMaps(),this._fillHTML(),this._show()}}),b}(),i=function(){var b=function(){this.dom=$("#mapManager"),this.mapTitle=$("#mapTitle"),this.mapOperations=$("#mapOperations"),this.mapLayerList=$("#mapLayerList"),this.mapEditor=new e,this.layerEditor=new f,this.layerListDataController=new g,this.layerListViewController=new h(this.layerListDataController),this.mapLayerListRender=_.template($("#mapLayerListTemplate").html()),this.userLoginRegister=new d,this._autoLogin(),this._bindEvent()};return c.extend(b.prototype,{_bindEvent:function(){var b=this;b.mapLayerList.on("click",".layer-list-manager-layer-t",function(){if($(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).removeClass("selected"),b.currentLayerIndex=$(this).attr("data-index"),$(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).addClass("selected"),$(this).parent().hasClass("hide-content"))$(this).parent().removeClass("hide-content");else{var a=$(this).find("h4").html();b.layerEditor.editLayer(a,function(a){b.updateLayerName(a)})}}).on("click",".checkbox",function(a){$(this).parent().parent().toggleClass("hide-content"),$(this).parent().parent().hasClass("hide-content")?b.hideLayerObjects(b.currentLayerIndex):($(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).removeClass("selected"),b.currentLayerIndex=$(this).attr("data-index"),$(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).addClass("selected"),b.showLayerObjects(b.currentLayerIndex)),a.stopPropagation()}),$(".layer-list-manager-bar").on("click",".operations",function(){b.mapOperations.toggle()}).on("click",".add-layer",function(){$(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).removeClass("selected"),b.currentLayerIndex=b.layers.length;var a={name:"未命名的图层",objectList:[]};b.mapLayerList.append(b.mapLayerListRender({layers:[a],fromIndex:b.layers.length})),b.layers.push(a),b.mapObject.layerList=b.layers,$(b.mapLayerList.find(".layer-list-manager-layer")[b.currentLayerIndex]).addClass("selected").removeClass("hide-content"),b.layerListDataController.updateMap(b.mapObject)}),b.mapOperations.on("click",".create",function(){b.mapOperations.hide(),b.mapEditor.createMap(function(a){b.showMap(b.layerListDataController.addMap(a))})}).on("click",".open",function(){b.mapOperations.hide(),b.layerListViewController.openMap(function(a){b.layerListDataController.setDefaultMap(a.id),b.showMap(a)})}).on("click",".delete",function(){b.mapOperations.hide(),b.layerListDataController.removeMap($(this).attr("data-mapId"))}),b.mapTitle.on("click",function(){b.mapEditor.editMap(b.mapObject.name,function(a){b.mapObject.name=a,b.mapTitle.text(a),b.layerListDataController.updateMap(b.mapObject)})}),$("#loginTrigger").on("click",function(){b._login()}),$("#logoutTrigger").on("click",function(){b._logout()}),a.cesiumDrawer.addListener("polylineCreated",function(a){b._addObject(a.id,"未命名的折线",a.positions)})},_fillHTML:function(){this.mapTitle.html(this.mapObject.name),this.mapLayerList.html(this.mapLayerListRender({layers:this.layers,fromIndex:0}))},_addObject:function(a,b,c){var d=$(this.mapLayerList.children()[this.currentLayerIndex]),e=this.layers[this.currentLayerIndex];e.objectList.push({id:a,name:b,cesiumInfos:c});var f=d.find(".layer-list-manager-layer-c"),g='<div class="layer-list-manager-layer-i polyline" data-id="'+a+'">'+b+"</div>";1===e.objectList.length?f.html(g):f.append(g),this.layerListDataController.updateMap(this.mapObject)},_autoLogin:function(){var a=this.userLoginRegister.autoLogin();a&&this._onUserLogin(a)},updateLayerName:function(a){var b=this.mapLayerList.children()[this.currentLayerIndex],c=$(b).find("h4");c.text(a),this.layers[this.currentLayerIndex].name=a,this.mapObject.layerList=this.layers,this.layerListDataController.updateMap(this.mapObject)},showMap:function(a){this.currentLayerIndex=0,this.mapObject=a,this.layers=a.layerList,this._fillHTML(),$(this.mapLayerList.children()[this.currentLayerIndex]).addClass("selected").removeClass("hide-content"),this.dom.fadeIn(100),this.showLayerObjects(0)},removeAllObjects:function(){for(var b=0;b<this.layers.length;b++)for(var c=this.layers[b],d=c.objectList,b=0;b<d.length;b++)a.cesiumDrawer.removeObject(d[b].id)},showLayerObjects:function(b){var c=this.layers[b];if(c)for(var d=c.objectList,e=0;e<d.length;e++)a.cesiumDrawer.drawOrShowObject(d[e])},hideLayerObjects:function(b){for(var c=this.layers[b],d=c.objectList,e=0;e<d.length;e++)a.cesiumDrawer.hideObject(d[e].id)},_onUserLogin:function(a){$("#usernameSpan").text(a.username),$("#loginTrigger").hide(),$("#userPanel").show(),this.layerListDataController.setUserid(a.userid);var b=this.layerListDataController.getLastEditMap();this.showMap(b),$(".search-bar").css("left",330),$("#layerTools").show()},_logout:function(){this.userLoginRegister.logout(),$("#loginTrigger").show(),$("#userPanel").hide(),$(".search-bar").css("left",30),$("#layerTools").hide(),this.dom.fadeOut(100),this.removeAllObjects()},_login:function(){var a=this;a.userLoginRegister.login(function(b){a._onUserLogin(b)})},start:function(){}}),b}(),j=function(){var b=function(){this.dom=$("#layerTools"),this.allTools=this.dom.find(".layer-tool"),this.layerToolsDistance=$("#layerToolsDistance"),this.layerToolsPolyline=$("#layerToolsPolyline"),this.layerToolsLabel=$("#layerToolsLabel"),this.layerToolsHand=$("#layerToolsHand"),this.init()};return c.extend(b.prototype,{init:function(){this.layerToolsHand.addClass("selected");var b=this;b.layerToolsHand.on("click",function(){a.uiApp.enableLocationShower=!0,b.allTools.removeClass("selected"),$(this).addClass("selected")}),b.layerToolsPolyline.on("click",function(){a.uiApp.enableLocationShower=!1,b.allTools.removeClass("selected"),$(this).addClass("selected"),a.cesiumDrawer.startDrawingPolyline()}),a.cesiumDrawer.addListener("polylineCreated",function(){a.uiApp.enableLocationShower=!0,b.allTools.removeClass("selected"),b.layerToolsHand.addClass("selected")}),b.layerToolsDistance.on("click",function(){a.uiApp.enableLocationShower=!1,b.allTools.removeClass("selected"),$(this).addClass("selected"),a.cesiumDrawer.startMeasureDistance()}),a.cesiumDrawer.addListener("measureDistanceFinished",function(){a.uiApp.enableLocationShower=!0,b.allTools.removeClass("selected"),b.layerToolsHand.addClass("selected")})}}),b}(),k=new i;k.start();new j}(window,document);
//# sourceMappingURL=iEarth.map